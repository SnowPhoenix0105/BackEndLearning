# Kuberneteså­¦ä¹ æ—¥è®°ï¼ˆä¸€ï¼‰

æš‘æœŸåŠ å…¥äº†æ²ƒå¤©å®‡è€å¸ˆçš„å®éªŒå®¤è¿›è¡Œæš‘æœŸçš„å®ä¹ ã€‚åœ¨æ­£å¼å¼€å§‹å·¥ä½œä¹‹å‰ï¼Œå¸ˆå…„å…ˆè®©æˆ‘äº†è§£ä¸€ä¸‹æŠ€æœ¯æ ˆï¼Œéœ€è¦äº†è§£çš„æœ‰dockerã€k8sã€springbootã€springcloudã€‚

è°¨ä»¥ä¸€ç³»åˆ—åšå®¢è®°å½•ä¸€ä¸‹è‡ªå·±å­¦ä¹ çš„ç¬”è®°ã€‚æ›´å¤šå†…å®¹è§[Github](https://github.com/SnowPhoenix0105/BackEndLearning)


2021/7/7

## å‚è€ƒèµ„æ–™

å®˜ç½‘ï¼š[https://kubernetes.io/](https://kubernetes.io/)

å› ä¸ºå®˜æ–¹æ–‡æ¡£æ”¯æŒä¸­æ–‡ï¼Œå¹¶ä¸”æŒºå…¨é¢çš„ï¼Œå°±å…ˆä¸éœ€è¦åˆ«çš„èµ„æ–™äº†ã€‚

## ä»€ä¹ˆæ˜¯k8s

å·²ç»äº†è§£äº†dockerè¿™ä¸ª`å®¹å™¨`çš„æ¦‚å¿µï¼Œk8såœ¨å®˜ç½‘ç»™å‡ºçš„æ¦‚å¿µå°±å¥½ç†è§£äº†ï¼š

k8sï¼Œå…¨ç§°Kubernetesï¼Œæ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„å¼€æºç³»ç»Ÿã€‚

å¦‚æœè¯´dockerç”¨æ¥æ„å»ºã€è¿è¡Œå®¹å™¨ï¼Œé‚£ä¹ˆk8såˆ™ç”¨æ¥éƒ¨ç½²å’Œç®¡ç†å®¹å™¨ã€‚

## åŸºæœ¬æ¦‚å¿µ

æœ¯è¯­è¡¨ï¼š[https://kubernetes.io/zh/docs/reference/glossary/](https://kubernetes.io/zh/docs/reference/glossary/)

* `pod`ï¼šé›†ç¾¤ä¸Šä¸€ç»„æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œæ˜¯å¯ä»¥åœ¨ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„ã€æœ€å°çš„å¯éƒ¨ç½²çš„è®¡ç®—å•å…ƒï¼›
* `node`ï¼šèŠ‚ç‚¹ï¼Œä¸€å°æœºå™¨ï¼›
* `cluster`ï¼šé›†ç¾¤ï¼›
* `controller`ï¼šæ§åˆ¶å™¨ï¼Œé€šè¿‡`apiserver`ç›‘æ§é›†ç¾¤çŠ¶æ€ã€å¹¶è‡´åŠ›äºå°†å½“å‰çŠ¶æ€è½¬æ¢æˆæœŸæœ›çŠ¶æ€çš„ç»„ä»¶ï¼›
* `service`ï¼šå°†è¿è¡Œåœ¨`pod`ä¸Šçš„åº”ç”¨æš´éœ²ä¸ºç½‘ç»œæœåŠ¡ï¼›
* `volume`ï¼šå·ï¼Œç±»ä¼¼äºdockerä¸­çš„volumeï¼Œä½†æ˜¯æä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œè¯¦è§[https://kubernetes.io/zh/docs/concepts/storage/volumes/](https://kubernetes.io/zh/docs/concepts/storage/volumes/)ï¼›
* 

### k8sç»„ä»¶

<img src="./images/components-of-kubernetes.svg">

* `Control Plane Components`ï¼šæ§åˆ¶é¢æ¿ï¼Œè´Ÿè´£æ£€æµ‹å’Œå“åº”é›†ç¾¤äº‹ä»¶ï¼Œå¯¹æ•´ä¸ªé›†ç¾¤åšå‡ºå…¨å±€å†³ç­–ï¼ˆå¦‚åœ¨æŸäº›æ¡ä»¶ä¸‹å¯åŠ¨æ–°çš„podï¼‰ï¼›
  * `kube-apiserver`ï¼šæ§åˆ¶é¢æ¿çš„å‰ç«¯ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆéƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼‰ï¼›
  * `etcd`ï¼šä¸€ä¸ªkey-valueæ•°æ®åº“ï¼Œä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„æ•°æ®çš„åå°æ•°æ®åº“ï¼›
  * `kube-scheduler`ï¼šä¸º`pod`åˆ†é…`node`çš„è°ƒåº¦å™¨ï¼›
  * `kube-controller-manager`ï¼šä¸€ç³»åˆ—æ§åˆ¶å™¨çš„æ•´åˆï¼Œæ”¯æŒæ°´å¹³æ‰©å±•ï¼›
    * `node controller`ï¼šèŠ‚ç‚¹æ§åˆ¶å™¨ï¼ŒèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº”ï¼›
    * `job controller`ï¼šç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„`Job`å¯¹è±¡ï¼Œç„¶ååˆ›å»º`pod`æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆï¼›
    * `endpoints controller`ï¼šå¡«å……ç«¯ç‚¹ï¼ˆEndpointsï¼‰å¯¹è±¡ï¼Œå³è¿æ¥`service`ä¸`pod`ï¼›
    * `service account & token controllers`ï¼šä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œï¼›
  * `cloud-controller-manager`ï¼šç”¨äºå’Œäº‘æœåŠ¡æä¾›å•†/äº‘å¹³å°äº¤äº’çš„æ§åˆ¶å™¨çš„é›†åˆï¼Œæ”¯æŒæ°´å¹³æ‰©å±•ï¼›
    * `node controller`ï¼šèŠ‚ç‚¹æ§åˆ¶å™¨ï¼Œç”¨äºåœ¨èŠ‚ç‚¹ç»ˆæ­¢å“åº”åæ£€æŸ¥äº‘æä¾›å•†ä»¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦å·²è¢«åˆ é™¤ï¼›
    * `route controller`ï¼šè·¯ç”±æ§åˆ¶å™¨ï¼Œç”¨äºåœ¨äº‘åŸºç¡€æ¶æ„ä¸­è®¾ç½®è·¯ç”±ï¼›
    * `service controller`ï¼šæœåŠ¡æ§åˆ¶å™¨ï¼Œç”¨äºåˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº‘å¹³å°çš„è´Ÿè½½å‡è¡¡ï¼›
* `Node Components`ï¼šèŠ‚ç‚¹ç»„ä»¶ï¼Œåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç»„ä»¶ï¼Œç»´æŠ¤`pod`å¹¶æä¾›k8sè¿è¡Œç¯å¢ƒï¼›
  * `kubelet`ï¼šåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»£ç†ï¼ˆagentï¼‰ï¼Œé€šè¿‡å¤šç§æ–¹å¼æ¥æ”¶`PodSpecs`å¹¶ä¿è¯å…¶ä¸­æè¿°çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ä¸”å¥åº·ï¼Œåªç®¡ç†ç”±k8såˆ›å»ºçš„å®¹å™¨ï¼›
  * `kube-proxy`ï¼šåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç½‘ç»œä»£ç†ï¼Œç»´æŠ¤èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œè§„åˆ™ï¼Œè¿™äº›è§„åˆ™å…è®¸ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¼šè¯ä¸`pod`è¿›è¡Œç½‘ç»œé€šä¿¡ï¼›
  * `container runtime`ï¼šå®¹å™¨çš„è¿è¡Œæ—¶ï¼Œk8sæ”¯æŒdockerã€containerdã€CRI-Oä»¥åŠä»»ä½•[Kubernetes CRI](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md)çš„å®ç°ï¼›
* `Addons`ï¼šæ’ä»¶ï¼Œæ’ä»¶é€šè¿‡ä½¿ç”¨k8sèµ„æºï¼Œæ¥å®ç°é›†ç¾¤å·¥èƒ½ï¼›
  * `DNS`ï¼šå’Œç¯å¢ƒä¸­å…¶å®ƒDNSæœåŠ¡å™¨ä¸€èµ·å·¥ä½œï¼Œå®ƒä¸ºk8sæœåŠ¡æä¾›DNSè®°å½•ï¼›
  * `dashboard`ï¼šä»ªè¡¨ç›˜ï¼Œæ˜¯ä¸€ä¸ªåŸºäºWebçš„ç”¨æˆ·ç•Œé¢ï¼Œæ–¹ä¾¿è¿›è¡Œç®¡ç†å’Œæ•…éšœæ’é™¤ï¼›
  * `container resource monitoring`ï¼šå®¹å™¨èµ„æºç›‘æ§ï¼Œå°†å®¹å™¨çš„ä¸€äº›å¸¸è§çš„æ—¶é—´åºåˆ—åº¦é‡å€¼ä¿å­˜åˆ°ä¸€ä¸ªè®°è´¦çš„æ•°æ®åº“ï¼Œå¹¶æä¾›æµè§ˆçš„é¡µé¢ï¼›
  * `cluster-level logging`ï¼šé›†ç¾¤æ—¥å¿—ï¼Œè´Ÿè´£å°†å®¹å™¨çš„æ—¥å¿—æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªé›†ä¸­çš„æ—¥å¿—å­˜å‚¨ä¸­ï¼Œè¯¥å­˜å‚¨æä¾›æœç´¢å’Œæµè§ˆæ¥å£ï¼›

### k8så¯¹è±¡

æ¯ä¸ªk8så¯¹è±¡æœ‰ä¸¤ä¸ªåµŒå¥—çš„å­—æ®µï¼š

* `spec`ï¼šè§„çº¦ï¼Œæè¿°æœŸæœ›çŠ¶æ€ï¼Œåˆ›å»ºå¯¹è±¡æ—¶ï¼Œç”±ç»´æŠ¤äººå‘˜æä¾›ï¼›
* `state`ï¼šå½“å‰çŠ¶æ€ï¼Œæœ‰å¯¹è±¡å®é™…æƒ…å†µäº§ç”Ÿï¼›

k8sçš„OpenAPIè¦æ±‚è¯·æ±‚ä½“ä¸­åŒ…å«JSONæ ¼å¼çš„specä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨kebectlæ—¶ï¼Œå¯ä»¥é€šè¿‡yamlæ–‡ä»¶æ¥æè¿°ã€‚ä»¥ä¸‹ä¸ºå®˜æ–¹ç¤ºä¾‹ï¼š

application/deployment.yaml

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2 # tells deployment to run 2 pods matching the template
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

å…¶ä¸­ä»¥ä¸‹å­—æ®µæ˜¯å¿…é¡»çš„ï¼š

* `apiVersion`ï¼šæ‰€ä½¿ç”¨çš„k8s APIç‰ˆæœ¬ï¼›
* `kind`ï¼šæ‰€åˆ›å»ºçš„çš„å¯¹è±¡çš„ç±»åˆ«ï¼›
* `metadata`ï¼š å¸®åŠ©å”¯ä¸€æ€§æ ‡è¯†å¯¹è±¡çš„ä¸€äº›æ•°æ®ï¼ŒåŒ…æ‹¬ä¸€ä¸ªnameå­—ç¬¦ä¸²ã€UIDå’Œå¯é€‰çš„namespace

æ›´å¤š`spec`å†…å®¹å¯ä»¥å‚è€ƒ[Kubernetes API](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/)

#### æ ‡è¯†å¯¹è±¡

å…³äºå”¯ä¸€åœ°æ ‡è¯†å¯¹è±¡ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯é€šè¿‡`name`ï¼Œä¸€ç§æ˜¯é€šè¿‡`UID`ã€‚

`UID`ç”±k8sç®¡ç†ï¼Œä¿è¯å…¨å±€å”¯ä¸€ã€‚

è€Œå¯¹äº`name`ï¼Œä¸¤ä¸ªåŒç±»å¯¹è±¡ä¸èƒ½åŒæ—¶æ‹¥æœ‰ä¸€æ ·çš„`name`ï¼Œå¹¶ä¸”`name`è§†æƒ…å†µå¯èƒ½éœ€è¦æ»¡è¶³[RFC 1123](https://datatracker.ietf.org/doc/html/rfc1123)ä¸­çš„`DNS subdomain`/`DNS label`çš„çº¦æŸï¼Œä¹Ÿå¯èƒ½éœ€è¦æ»¡è¶³è·¯å¾„åçº¦æŸï¼Œæ€»çš„æ¥è¯´ï¼Œæ»¡è¶³ä¸‹é¢4ä¸ªçº¦æŸå°±å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†æƒ…å†µï¼š

1. ä¸å¤šäº63ä¸ªå­—ç¬¦;
2. åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ï¼Œä»¥åŠ'-';
3. é¡»ä»¥å­—æ¯/æ•°å­—å¼€å¤´;
4. é¡»ä»¥å­—æ¯/æ•°å­—ç»“å°¾;

å½“éœ€è¦çš„åå­—è¿‡å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡[å‘½åç©ºé—´](https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/namespaces/)æ¥è¿›è¡Œç®¡ç†ã€‚


#### metadata

é™¤äº†å‰é¢æåˆ°çš„nameå­—ç¬¦ä¸²ã€UIDå’Œå¯é€‰çš„namespaceï¼Œmetadataè¿˜å¯ä»¥ä¿å­˜æ›´å¤šå¯¹è±¡ä¿¡æ¯ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡[æ ‡ç­¾](https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/labels/)æ¥è¿›è¡Œæ›´ç»†è‡´çš„æ¡ä»¶ç­›é€‰ã€‚k8sä¸­ï¼Œæ ‡ç­¾æ˜¯ä¸€ç§key-valueç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­æŸä¸ªkeyå¯¹åº”çš„valueæ˜¯å¦ç¬¦åˆè¦æ±‚æ¥ç­›é€‰å¯¹è±¡ã€‚

å®˜æ–¹ç»™å‡ºäº†ä¸€äº›æ ‡ç­¾çš„ç¤ºä¾‹ï¼š

* `"release":"stable"`, `"release":"canary"`
* `"environment":"dev"`, `"environment":"qa"`, `"environment":"production"`
* `"tier":"frontend"`, `"tier":"backend"`, `"tier":"cache"`
* `"partition":"customerA"`, `"partition":"customerB"`
* `"track":"daily"`, `"track":"weekly"`

æ¨èä½¿ç”¨çš„æ ‡ç­¾å¦‚ä¸‹ï¼š[https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/common-labels/](https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/common-labels/)

è€Œå¦ä¸€ç§ä¿¡æ¯æ˜¯[æ³¨è§£](https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/annotations/)ã€‚æ³¨è§£ä¹Ÿæ˜¯ä¸€ç§key-valueç»“æ„ï¼Œå’Œæ ‡ç­¾çš„è¡¨ç°å½¢å¼å¾ˆåƒï¼Œä½†ä¸åŒäºæ ‡ç­¾ï¼Œæ³¨è§£ä¸èƒ½ç”¨äºç­›é€‰ã€‚

å®˜æ–¹ç»™å‡ºäº†ä½¿ç”¨æ³¨è§£çš„ä¸€äº›åœºæ™¯ï¼š

* ç”±å£°æ˜æ€§é…ç½®æ‰€ç®¡ç†çš„å­—æ®µã€‚ å°†è¿™äº›å­—æ®µé™„åŠ ä¸ºæ³¨è§£ï¼Œèƒ½å¤Ÿå°†å®ƒä»¬ä¸å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯è®¾ç½®çš„é»˜è®¤å€¼ã€ è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µä»¥åŠé€šè¿‡è‡ªåŠ¨è°ƒæ•´å¤§å°æˆ–è‡ªåŠ¨ä¼¸ç¼©ç³»ç»Ÿè®¾ç½®çš„å­—æ®µåŒºåˆ†å¼€æ¥ã€‚
* æ„å»ºã€å‘å¸ƒæˆ–é•œåƒä¿¡æ¯ï¼ˆå¦‚æ—¶é—´æˆ³ã€å‘å¸ƒ IDã€Git åˆ†æ”¯ã€PR æ•°é‡ã€é•œåƒå“ˆå¸Œã€ä»“åº“åœ°å€ï¼‰ã€‚
* æŒ‡å‘æ—¥å¿—è®°å½•ã€ç›‘æ§ã€åˆ†ææˆ–å®¡è®¡ä»“åº“çš„æŒ‡é’ˆã€‚
* å¯ç”¨äºè°ƒè¯•ç›®çš„çš„å®¢æˆ·ç«¯åº“æˆ–å·¥å…·ä¿¡æ¯ï¼šä¾‹å¦‚ï¼Œåç§°ã€ç‰ˆæœ¬å’Œæ„å»ºä¿¡æ¯ã€‚
* ç”¨æˆ·æˆ–è€…å·¥å…·/ç³»ç»Ÿçš„æ¥æºä¿¡æ¯ï¼Œä¾‹å¦‚æ¥è‡ªå…¶ä»–ç”Ÿæ€ç³»ç»Ÿç»„ä»¶çš„ç›¸å…³å¯¹è±¡çš„ URLã€‚
* è½»é‡çº§ä¸Šçº¿å·¥å…·çš„å…ƒæ•°æ®ä¿¡æ¯ï¼šä¾‹å¦‚ï¼Œé…ç½®æˆ–æ£€æŸ¥ç‚¹ã€‚
* è´Ÿè´£äººå‘˜çš„ç”µè¯æˆ–å‘¼æœºå·ç ï¼Œæˆ–æŒ‡å®šåœ¨ä½•å¤„å¯ä»¥æ‰¾åˆ°è¯¥ä¿¡æ¯çš„ç›®å½•æ¡ç›®ï¼Œå¦‚å›¢é˜Ÿç½‘ç«™ã€‚
* ä»ç”¨æˆ·åˆ°æœ€ç»ˆè¿è¡Œçš„æŒ‡ä»¤ï¼Œä»¥ä¿®æ”¹è¡Œä¸ºæˆ–ä½¿ç”¨éæ ‡å‡†åŠŸèƒ½ã€‚

ç›¸æ¯”äºå°†è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨æ•°æ®åº“æˆ–æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨æ³¨è§£å¯ä»¥æ–¹ä¾¿å¼€å‘äººå‘˜ç”Ÿæˆç”¨äºéƒ¨ç½²ã€ç®¡ç†ã€è‡ªæ£€çš„å®¢æˆ·ç«¯å…±äº«åº“å’Œå·¥å…·ã€‚



## å®‰è£…

å®‰è£…é€‚åˆç”¨äºå­¦ä¹ çš„minikubeï¼š[https://minikube.sigs.k8s.io/docs/start/](https://minikube.sigs.k8s.io/docs/start/)ã€‚

minikubeæ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹çš„k8sã€‚

ç„¶åå®‰è£…å‘½ä»¤è¡Œè¾…åŠ©å·¥å…·kubectlï¼š[https://kubernetes.io/zh/docs/tasks/tools/install-kubectl-windows/](https://kubernetes.io/zh/docs/tasks/tools/install-kubectl-windows/)

è¿™é‡Œä¸‹è½½ä¸‹æ¥çš„æ˜¯ä¸€ä¸ªå•ä½“çš„exeï¼Œç›´æ¥æ”¾åœ¨ä¸€ä¸ªåœ¨PATHä¸­çš„æ–‡ä»¶å¤¹é‡Œå°±å¯ä»¥äº†ã€‚


## åˆ›å»ºé›†ç¾¤

åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªé›†ç¾¤ï¼š

```powershell
minikube start
```

è·å–é›†ç¾¤ä¿¡æ¯ï¼š

```powershell
kubectl cluster-info
```

è·å–èŠ‚ç‚¹ä¿¡æ¯ï¼š

```powershell
kubectl get nodes
```

ç»“æœå¦‚ä¸‹ï¼ˆå°†è·¯å¾„ç­‰æ— å…³ä¿¡æ¯åˆ å»äº†ï¼‰ï¼š

```powershell
PS D:\xxxx\Learning> minikube start
ğŸ˜„  Microsoft Windows 10 Home China 10.0.19041 Build 19041 ä¸Šçš„ minikube v1.21.0
âœ¨  æ ¹æ®ç°æœ‰çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ docker é©±åŠ¨ç¨‹åº
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸšœ  Pulling base image ...
ğŸƒ  Updating the running docker "minikube" container ...
â—  This container is having trouble accessing https://k8s.gcr.io
ğŸ’¡  To pull new external images, you may need to configure a proxy: https://minikube.sigs.k8s.io/docs/reference/networking/proxy/
ğŸ³  æ­£åœ¨ Docker 20.10.7 ä¸­å‡†å¤‡ Kubernetes v1.20.7â€¦
ğŸ”  Verifying Kubernetes components...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default    
PS D:\xxxx\Learning> kubectl cluster-info
Kubernetes control plane is running at https://127.0.0.1:57180
KubeDNS is running at https://127.0.0.1:57180/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
PS D:\xxxx\Learning> kubectl get nodes
NAME       STATUS   ROLES    AGE     VERSION
minikube   Ready    <none>   3m51s   v1.20.7
```

å¯åŠ¨minikube dashboardï¼š

```powershell
minikube dashboard
```

ç„¶åå°±å¯ä»¥åœ¨æµè§ˆå™¨è®¿é—®dashboardäº†ï¼š

<img src="./images/dashboard.png" style="zoom: 80%">

## åˆ›å»ºDeployment 

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªDeploymentï¼š

```powershell
kubectl create deployment hello-node --image=k8s.gcr.io/echoserver:1.4
```

* `hello-node`æ˜¯è¿™ä¸ªdeploymentçš„åå­—ï¼›
* `--image`æŒ‡å®šäº†åˆ›å»ºdeploymentæ‰€ä½¿ç”¨çš„é•œåƒï¼›

æŸ¥çœ‹deploymentä¿¡æ¯ï¼š

```powershell
kubectl get deployments
```

æŸ¥çœ‹podä¿¡æ¯ï¼š

```powershell
kubectl get pods
```

æŸ¥çœ‹é›†ç¾¤äº‹ä»¶ï¼š

```powershell
kubectl get events
```

æŸ¥çœ‹kubectlé…ç½®ï¼š

```powershell
kubectl config view
```

ç»“æœå¦‚ä¸‹ï¼š

```powershell
PS D:\xxxx\Learning> kubectl create deployment hello-node --image=k8s.gcr.io/echoserver:1.4
deployment.apps/hello-node created
PS D:\xxxx\Learning> kubectl get deployments
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
hello-node   0/1     1            0           11s
PS D:\xxxx\Learning> kubectl get pods
hello-node-7567d9fdc9-z879j   0/1     ImagePullBackOff   0          2m41s
PS D:\xxxx\Learning> kubectl get events
LAST SEEN   TYPE      REASON                    OBJECT                             MESSAGE
2m59s       Normal    Scheduled                 pod/hello-node-7567d9fdc9-z879j    Successfully assigned default/hello-node-7567d9fdc9-z879j to minikube
38s         Normal    Pulling                   pod/hello-node-7567d9fdc9-z879j    Pulling image "k8s.gcr.io/echoserver:1.4"
23s         Warning   Failed                    pod/hello-node-7567d9fdc9-z879j    Failed to pull image "k8s.gcr.io/echoserver:1.4": rpc error: code = Unknown desc = Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
23s         Warning   Failed                    pod/hello-node-7567d9fdc9-z879j    Error: ErrImagePull
9s          Normal    BackOff                   pod/hello-node-7567d9fdc9-z879j    Back-off pulling 
image "k8s.gcr.io/echoserver:1.4"
9s          Warning   Failed                    pod/hello-node-7567d9fdc9-z879j    Error: ImagePullBackOff
2m59s       Normal    SuccessfulCreate          replicaset/hello-node-7567d9fdc9   Created pod: hello-node-7567d9fdc9-z879j
2m59s       Normal    ScalingReplicaSet         deployment/hello-node              Scaled up replica set hello-node-7567d9fdc9 to 1
19m         Normal    NodeHasSufficientMemory   node/minikube                      Node minikube status is now: NodeHasSufficientMemory
19m         Normal    NodeHasNoDiskPressure     node/minikube                      Node minikube status is now: NodeHasNoDiskPressure
19m         Normal    NodeHasSufficientPID      node/minikube                      Node minikube status is now: NodeHasSufficientPID
19m         Normal    Starting                  node/minikube                      Starting kubelet.19m         Normal    NodeHasSufficientMemory   node/minikube                      Node minikube status is now: NodeHasSufficientMemory
19m         Normal    NodeHasNoDiskPressure     node/minikube                      Node minikube status is now: NodeHasNoDiskPressure
19m         Normal    NodeHasSufficientPID      node/minikube                      Node minikube status is now: NodeHasSufficientPID
19m         Normal    NodeAllocatableEnforced   node/minikube                      Updated Node Allocatable limit across pods
18m         Normal    RegisteredNode            node/minikube                      Node minikube event: Registered Node minikube in Controller
17m         Normal    Starting                  node/minikube                      Starting kube-proxy.
PS D:\xxxx\Learning> kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority: C:\Users\SnowPhoenix\.minikube\ca.crt
    extensions:
    - extension:
        last-update: Wed, 07 Jul 2021 16:17:25 CST
        provider: minikube.sigs.k8s.io
        version: v1.21.0
      name: cluster_info
    server: https://127.0.0.1:57180
  name: minikube
contexts:
- context:
    cluster: minikube
    extensions:
    - extension:
        last-update: Wed, 07 Jul 2021 16:17:25 CST
        provider: minikube.sigs.k8s.io
        version: v1.21.0
      name: context_info
    namespace: default
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: C:\Users\SnowPhoenix\.minikube\profiles\minikube\client.crt
    client-key: C:\Users\SnowPhoenix\.minikube\profiles\minikube\client.key
```

å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶`deployment.apps/hello-node`æˆåŠŸåˆ›å»ºäº†ï¼Œä½†æ˜¯å´å¤„äºä¸å¯ç”¨çŠ¶æ€ï¼Œæœ‰ä¸€ä¸ª`ImagePullBackOff`æŠ¥é”™ï¼Œä»`kubectl get events`ä¸­çš„ä¿¡æ¯æ¥çœ‹ï¼Œåº”è¯¥æ˜¯`image pull`å¤±è´¥äº†ã€‚

ç®€å•æŸ¥è¯¢äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯å› ä¸ºå›½å†…æ‹‰ä¸åˆ°`k8s.gcr.io`çš„é•œåƒã€‚å¯ä»¥é€šè¿‡docker.ioçš„é•œåƒæ¥æ›²çº¿æ•‘å›½ã€‚

å…ˆé€šè¿‡é•œåƒæ‹‰å–é•œåƒï¼š

```powershell
docker pull mirrorgooglecontainers/echoserver:1.4
```

ç„¶åé€šè¿‡`docker tag`æ¥â€œæ”¹åâ€ï¼š

```powershell
docker tag docker.io/mirrorgooglecontainers/echoserver:1.4 k8s.gcr.io/echoserver:1.4
```

æ­¤æ—¶é€šè¿‡`docker images`å¯ä»¥çœ‹åˆ°`k8s.gcr.io/echoserver:1.4`é•œåƒå·²ç»å­˜å­˜åœ¨æœ¬åœ°ä»“åº“ä¸­äº†ï¼š

```powershell
PS D:\xxxx\Learning> docker images
REPOSITORY                          TAG         IMAGE ID       CREATED        SIZE
mirrorgooglecontainers/echoserver   1.4         a90209bb39e3   5 years ago    140MB
k8s.gcr.io/echoserver               1.4         a90209bb39e3   5 years ago    140MB
```

ç„¶åå†åˆ é™¤åŸå…ˆçš„deploymentï¼š

```powershell
kubectl delete deployment hello-node
```

ç„¶åå†é‡æ–°æ‰§è¡Œä¹‹å‰çš„æ­¥éª¤ï¼Œå‘ç°è¿˜æ˜¯ä¸è¡Œã€‚é‡å¯ä¹‹åè¿˜æ˜¯ä¸è¡Œï¼Œå°±ç®—dockerä»“åº“ä¸­å·²ç»æœ‰è¿™ä¸ªé•œåƒäº†ï¼Œå¯åŠ¨podsçš„æ—¶å€™è¿˜æ˜¯ä¼šå°è¯•pullã€‚æ‰€ä»¥åªå¥½å¹²è„†åˆ›å»ºpodsçš„æ—¶å€™å°±ä½¿ç”¨é•œåƒï¼š

```powershell
kubectl create deployment hello-node --image=mirrorgooglecontainers/echoserver:1.4
```

## åˆ›å»ºService

é»˜è®¤æƒ…å†µä¸‹ï¼Œpodåªèƒ½é€šè¿‡é›†ç¾¤ä¸­çš„å†…éƒ¨IPåœ°å€è®¿é—®ã€‚ è¦ä½¿å¾—hello-nodeå®¹å™¨å¯ä»¥ä»k8sè™šæ‹Ÿç½‘ç»œçš„å¤–éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬éœ€è¦å°†podæš´éœ²ä¸ºserviceã€‚

```powershell
kubectl expose deployment hello-node --type=LoadBalancer --port=8080
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹serviceçš„æ·»åŠ æƒ…å†µï¼š

```powershell
kubectl get services
```

å…¶ä¸­`services`å¯ä»¥ç®€å†™ä¸º`svc`ã€‚

```powershell
PS D:\xxx\Learning> kubectl get services
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
hello-node   LoadBalancer   10.109.78.212   <pending>     8080:32610/TCP   11s
kubernetes   ClusterIP      10.96.0.1       <none>        443/TCP          3h32m
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ·»åŠ äº†åä¸º`hello-node`ã€ç±»å‹ä¸º`LoadBalancer`ï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰çš„æœåŠ¡ï¼Œå¹¶ä¸”æ˜ å°„åˆ°äº†å®¿ä¸»æœºç«¯å£8080ã€‚ä½†æ˜¯æ­¤æ—¶è®¿é—®`localhost:8080`å¹¶ä¸èƒ½è®¿é—®åˆ°ï¼Œè¿˜éœ€è¦æ‰§è¡Œå‘½ä»¤ï¼š

```powershell
minikube service hello-node
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘½ä»¤è¡Œè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š

```powershell
|-----------|------------|-------------|---------------------------|
| NAMESPACE |    NAME    | TARGET PORT |            URL            |
|-----------|------------|-------------|---------------------------|
| default   | hello-node |        8080 | http://192.168.49.2:32610 |
|-----------|------------|-------------|---------------------------|
ğŸƒ  Starting tunnel for service hello-node.
|-----------|------------|-------------|------------------------|
| NAMESPACE |    NAME    | TARGET PORT |          URL           |
|-----------|------------|-------------|------------------------|
| default   | hello-node |             | http://127.0.0.1:63313 |
|-----------|------------|-------------|------------------------|
ğŸ‰  æ­£é€šè¿‡é»˜è®¤æµè§ˆå™¨æ‰“å¼€æœåŠ¡ default/hello-node...
â—  Because you are using a Docker driver on windows, the terminal needs to be open to run it.
```

è®¿é—®`http://127.0.0.1:63313`å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›äº†æˆ‘ä»¬æ‰€å‘é€çš„è¯·æ±‚çš„ä¿¡æ¯ï¼š

<img src="./images/echo-success.png" style="zoom: 40%">

é€šè¿‡PostManï¼Œæˆ‘ä»¬å¯ä»¥å‘é€å…¶å®ƒçš„ä¿¡æ¯ï¼Œä¹Ÿéƒ½ä»å“åº”ä½“ä¸­æ‹¿åˆ°äº†echoçš„ç»“æœï¼š

<img src="./images/echo-postman.png" style="zoom: 40%">

## å¯åŠ¨æ’ä»¶

åˆ—å‡ºå½“å‰æ”¯æŒçš„æ’ä»¶ï¼š

```powershell
minikube addons list
```

å¯ä»¥å‘ç°æœ‰äº›æ’ä»¶å·²ç»å¯åŠ¨äº†ï¼š

```powershell
|-----------------------------|----------|--------------|
|         ADDON NAME          | PROFILE  |    STATUS    |
|-----------------------------|----------|--------------|
| ambassador                  | minikube | disabled     |
| auto-pause                  | minikube | disabled     |
| csi-hostpath-driver         | minikube | disabled     |
| dashboard                   | minikube | enabled âœ…   | 
| default-storageclass        | minikube | enabled âœ…   | 
| efk                         | minikube | disabled     |
| freshpod                    | minikube | disabled     |
| gcp-auth                    | minikube | disabled     |
| gvisor                      | minikube | disabled     |
| helm-tiller                 | minikube | disabled     |
| ingress                     | minikube | disabled     |
| ingress-dns                 | minikube | disabled     |
| istio                       | minikube | disabled     |
| istio-provisioner           | minikube | disabled     |
| kubevirt                    | minikube | disabled     |
| logviewer                   | minikube | disabled     |
| metallb                     | minikube | disabled     |
| metrics-server              | minikube | disabled     |
| nvidia-driver-installer     | minikube | disabled     |
| nvidia-gpu-device-plugin    | minikube | disabled     |
| olm                         | minikube | disabled     |
| pod-security-policy         | minikube | disabled     |
| registry                    | minikube | disabled     |
| registry-aliases            | minikube | disabled     |
| registry-creds              | minikube | disabled     |
| storage-provisioner         | minikube | enabled âœ…   | 
| storage-provisioner-gluster | minikube | disabled     |
| volumesnapshots             | minikube | disabled     |
|-----------------------------|----------|--------------|
```

å¯åŠ¨æ’ä»¶`metrics-server`ï¼š

```powershell
minikube addons enable metrics-server
```


## æ¸…ç†èµ„æº

å…³é—­æ’ä»¶`metrics-server`

```powershell
minikube addons disable metrics-server
```

åˆ é™¤æœåŠ¡

```powershell
kubectl delete service hello-node
```


åˆ é™¤deployment

```powershell
kubectl delete deployment hello-node
```


åœæ­¢minikubeè™šæ‹Ÿæœº

```powershell
minikube stop
```


åˆ é™¤minikubeè™šæ‹Ÿæœº

```powershell
minikube delete
```


## å°ç»“

ä»Šå¤©ï¼Œæˆ‘ä»¬äº†è§£äº†ä¸€äº›k8sçš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä¸”å°è¯•è¿›è¡Œäº†ä¸€æ¬¡éƒ¨ç½²ï¼Œå¹¶æˆåŠŸè¿›è¡Œäº†è®¿é—®ã€‚
