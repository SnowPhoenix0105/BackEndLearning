# Docker学习笔记

暑期加入了沃天宇老师的实验室进行暑期的实习。在正式开始工作之前，师兄先让我了解一下技术栈，需要了解的有docker、k8s、springboot、springcloud。

仅以一系列博客记录一下自己学习的笔记。更多内容见[Github](https://github.com/SnowPhoenix0105/BackEndLearning)



## 参考资料

* docker官网: [https://www.docker.com/](https://www.docker.com/)
* 菜鸟教程: [https://www.runoob.com/docker/docker-tutorial.html](https://www.runoob.com/docker/docker-tutorial.html)
* docker中文社区: [https://www.docker.org.cn/](https://www.docker.org.cn/)


## 什么是docker？

在开始学习之前，先连带猜测给docker下一个定义，深入学习之后再回头来验证一下。

docker的作用应当是解决程序的环境问题，通过将环境和程序一起打包，使得能够方便地在不同计算机上恢复程序所需要的环境并运行程序。

这将解决开发过程中的环境不一致问题，大大降低部署时的环境问题。

相比于虚拟机，docker应当具有较高的效率和较低的代价。


## 安装

Linux参考：[https://docs.docker.com/engine/install/](https://docs.docker.com/engine/install/)
Windows参考：[https://docs.docker.com/docker-for-windows/install/]

## demo

首先，下载官方的[示例app](https://github.com/docker/getting-started/tree/master/app)，将仓库中多余部分删除，保留app文件夹，并重命名为[gov-sample-app](../gov-sample-app)。

创建[Dockerfile](../gov-sample-app/Dockerfile):

```Dockerfile
# syntax=docker/dockerfile:1
FROM node:12-alpine
RUN apk add --no-cache python g++ make
WORKDIR /app
COPY . .
RUN yarn install --production
CMD ["node", "src/index.js"]
```

1. 第一句，`FROM`语句制定了初始的image，由于本地没有这个image，所以会从仓库中下载；
2. 第二句，`RUN`，应当是指定了一些需要使用的包，到这一步应当也是下载安装，作用应当是作为第一句引入的image的补充，添补额外的应用；
3. 第三句，看起来应当是指定一个运行目录，但是这个目录是容器内的目录还是



然后切换到`gov-sample-app`文件夹下运行：

```bash
docker build -t getting-started .
```

这个命令通过刚刚创建的Dockerfile来创建一个docker镜像。其中`-t`指令为该镜像指定一个tag，我们运行这个镜像的时候可以通过这个tag来指代这个镜像。

此时先开始下载所需要的依赖，包括`node:12-alpine`镜像和后面的`python g++ make`。但是此时发现下载速度感人，需要进行换源。

因为我是在自己的阿里云服务器上进行实验，所以换了阿里的源[https://cr.console.aliyun.com/cn-beijing/instances/mirrors](https://cr.console.aliyun.com/cn-beijing/instances/mirrors)。

重试发现仍不奏效，应当是第二步中`apk add`的问题。简单搜索之后了解到，这里使用的镜像`Alpine`其实是一个Linux发行版，因为其具有轻量化的优点，所以经常作为docker容器中使用的OS。因此，造成目前卡顿的原因是Alpine的包管理工具apk从仓库下载速度过慢，应当对apk进行换源。

在第一句`FROM`后再加一行以进行换源：
```Dockerfile
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories 
```

虽然还是有些慢，但是好多了。最后Build成功，以下为输出：

```console
$ sudo docker build -t getting-started .
Sending build context to Docker daemon  4.659MB
Step 1/7 : FROM node:12-alpine
 ---> deeae3752431
Step 2/7 : RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
 ---> Running in bb1b2b2fca8d
Removing intermediate container bb1b2b2fca8d
 ---> 306dcbb9fb1b
Step 3/7 : RUN apk add --no-cache python g++ make
 ---> Running in b9c56ec12a6b
fetch http://mirrors.aliyun.com/alpine/v3.11/main/x86_64/APKINDEX.tar.gz
fetch http://mirrors.aliyun.com/alpine/v3.11/community/x86_64/APKINDEX.tar.gz
(1/21) Installing binutils (2.33.1-r1)
(2/21) Installing gmp (6.1.2-r1)
(3/21) Installing isl (0.18-r0)
(4/21) Installing libgomp (9.3.0-r0)
(5/21) Installing libatomic (9.3.0-r0)
(6/21) Installing mpfr4 (4.0.2-r1)
(7/21) Installing mpc1 (1.1.0-r1)
(8/21) Installing gcc (9.3.0-r0)
(9/21) Installing musl-dev (1.1.24-r3)
(10/21) Installing libc-dev (0.7.2-r0)
(11/21) Installing g++ (9.3.0-r0)
(12/21) Installing make (4.2.1-r2)
(13/21) Installing libbz2 (1.0.8-r1)
(14/21) Installing expat (2.2.9-r1)
(15/21) Installing libffi (3.2.1-r6)
(16/21) Installing gdbm (1.13-r1)
(17/21) Installing ncurses-terminfo-base (6.1_p20200118-r4)
(18/21) Installing ncurses-libs (6.1_p20200118-r4)
(19/21) Installing readline (8.0.1-r0)
(20/21) Installing sqlite-libs (3.30.1-r2)
(21/21) Installing python2 (2.7.18-r0)
Executing busybox-1.31.1-r10.trigger
OK: 212 MiB in 37 packages
Removing intermediate container b9c56ec12a6b
 ---> 30167547cd72
Step 4/7 : WORKDIR /app
 ---> Running in 28935dd6ee9b
Removing intermediate container 28935dd6ee9b
 ---> 9b4f5c2f993f
Step 5/7 : COPY . .
 ---> 9e6b8013cc6f
Step 6/7 : RUN yarn install --production
 ---> Running in ffcc047905f0
yarn install v1.22.5
[1/4] Resolving packages...
[2/4] Fetching packages...
info There appears to be trouble with your network connection. Retrying...
info fsevents@1.2.9: The platform "linux" is incompatible with this module.
info "fsevents@1.2.9" is an optional dependency and failed compatibility check. Excluding it from installation.
[3/4] Linking dependencies...
[4/4] Building fresh packages...
Done in 93.45s.
Removing intermediate container ffcc047905f0
 ---> 4f85bb916dc2
Step 7/7 : CMD ["node", "src/index.js"]
 ---> Running in 05444490086d
Removing intermediate container 05444490086d
 ---> 302e7c6b161a
Successfully built 302e7c6b161a
Successfully tagged getting-started:latest
```

